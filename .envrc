echo "Loading .envrc..."

# Load nvm if available and use the specified Node version
if [ -s "$HOME/.nvm/nvm.sh" ]; then
  source "$HOME/.nvm/nvm.sh"
  nvm use
fi

# CONFIGS
#########

# Fix for Scaffolder plugin
export NODE_OPTIONS="${NODE_OPTIONS:-} --no-node-snapshot"

# Static configuration
export APP_CONFIG_app_title='Open Service Portal'


# SECRETS
#########

# Check requirements for secrets
if ! command -v sops &> /dev/null; then
  echo "⚠ SOPS not found - skipping secret loading"
  return
fi

# Decrypt .env.enc and export secret variables (GitHub App credentials)
set -a
if source <(sops -d --input-type dotenv --output-type dotenv .env.enc 2>/dev/null); then
  echo "✓ Secrets loaded from .env.enc"
else
  echo "✗ Failed to decrypt .env.enc - check your SSH key"
fi
set +a

# Decrypt GitHub App private key (only if not already decrypted)
if [ -f github-app-key.pem ]; then
  echo "✓ GitHub App key already decrypted"
elif sops -d --input-type binary --output-type binary github-app-key.pem.enc > github-app-key.pem 2>/dev/null; then
  echo "✓ GitHub App key decrypted"
else
  echo "✗ Failed to decrypt GitHub App key"
fi

# Export GitHub App key variables if file exists
if [ -f github-app-key.pem ]; then
  export AUTH_GITHUB_APP_PRIVATE_KEY_FILE="$(pwd)/github-app-key.pem"
  export AUTH_GITHUB_APP_PRIVATE_KEY_B64="$(base64 < "$AUTH_GITHUB_APP_PRIVATE_KEY_FILE")"
fi
